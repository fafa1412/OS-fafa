# 第四章：地址空间
## 分页式内存管理
* 内核始终以一个同样大小的单位来在物理内存上放置应用地址空间中的数据，使得内存分配算法比较简单且不会产生外碎片；
  
* 同时，这个单位的大小要足够小，从而其内部没有被用到的内碎片的大小也足够小，尽可能提高内存利用率。
 ![image](https://github.com/fafa1412/OS-fafa/assets/145512978/ef5aaded-14b3-4f35-8e5f-4fa8b12b1a56)
页表可以看成一个键值对，其键的类型为虚拟页号，值的类型则为物理页号。
## 地址格式与组成
 ![image](https://github.com/fafa1412/OS-fafa/assets/145512978/abbc762c-d9db-4843-ba9f-cbcd689e6dbb)
 两种地址低12位为页内偏移，其余为页号。当 MMU 进行地址转换的时候，MMU首先找到虚拟地址所在虚拟页面的页号，然后查当前应用的页表，根据虚拟页号找到物理页号；最后按照虚拟地址的页内偏移，给物理页号对应的物理页帧的起始地址加上一个偏移量，这就得到了实际访问的物理地址。
## 多级页表
 ![image](https://github.com/fafa1412/OS-fafa/assets/145512978/fb28b51c-7050-49c3-a58a-7e3ee3f3f845)
假设有虚拟地址 vpn0，VPN1，vpn2，offset
我们首先会记录装载「当前所用的一级页表的物理页」的页号到 satp 寄存器中；

把vpn0作为偏移在一级页表的物理页中找到二级页表的物理页号；

把VPN1作为偏移在二级页表的物理页中找到三级页表的物理页号；

把VPN2作为偏移在三级页表的物理页中找到要访问位置的物理页号；

物理页号对应的物理页基址（即物理页号左移12位）加上 offset就是虚拟地址对应的物理地址。
## 物理页帧管理
alloc和dealloc函数实现分配回收功能；

物理页号区间 [ current , end )表示内存范围，向量 recycled 以后入先出的方式保存了被回收的物理页号；

current+1，代表已被分配；

封装为分配回收接口公开给其他模块使用；

借用了RAII 的思想，将一个物理页帧的生命周期绑定到一个 FrameTracker 变量上，只需为 FrameTracker 实现 Drop Trait ，当一个 FrameTracker 实例被回收的时候，它的 drop 方法会自动被编译器调用。
## 多级页表管理。
通过map和unmap方法增删键值对，需要建立vpn到ppn的映射关系，恒等映射
### 内核中访问物理页帧
都是先把物理页号转为物理地址 PhysAddr ，然后再转成 usize 形式的物理地址。接着，直接将它转为裸指针（自身代表一个地址）用来访问物理地址指向的物理内存。

分页机制开始后，罗指针被视作虚拟地址，基于恒等映射，也成立
### map unmap实现
PageTable::find_pte_create 在多级页表找到一个虚拟页号对应的页表项的可变引用。如果在遍历的过程中发现有节点尚未创建则会新建一个节点。

PageTable::find_pte找不到合法叶子节点时不会创建，而是返回none

据此，只需根据虚拟页号找到页表项，然后修改或者直接清空其内容即可。
## 内核地址空间
逻辑段：一段连续地址的虚拟内存 .bss .data等

地址空间：一系列有关联的逻辑段，意义在于隔离

   push 方法在地址空间中插入一个逻辑段 MapArea

从低到高，内核四个逻辑段（ U 标志位均未被设置，使只在s级可访问），内核栈及中间的保护页面（不存在相关映射，为了尽早捕获异常），顶层跳板
## 应用地址空间
从低到高，各个逻辑段，用户栈，trap上下文（切换空间发货作用），跳板

# 第五章：进程与进程管理
## 重要系统调用
fork：功能：当前进程 fork 出来一个子进程。返回值：对于子进程返回 0，对于当前进程则返回子进程的 PID 。

exec：功能：将当前进程的地址空间清空并加载一个特定的可执行文件，返回用户态后开始它的执行。（结合可以创建一个子进程并执行特定文件）

waitpid：功能：当前进程等待一个子进程变为僵尸进程，回收其全部资源并收集其返回值。返回值：如果要等待的子进程不存在则返回 -1；否则如果要等待的子进程均未结束则返回 -2； 
## 进程管理的核心数据结构
* 进程标识符：同一时间存在的所有进程都有一个唯一的进程标识符，是互不相同的整数
* 进程控制块：保存进程的执行状态、资源控制等元数据，将可能发生变化的数据放在任务控制块中
* 任务管理器：仅负责管理所有任务（进程）
* 处理器管理结构： 负责从任务管理器 TaskManager 中分出去的维护 CPU 状态的职责
